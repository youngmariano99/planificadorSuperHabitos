@page "/"
@using Microsoft.AspNetCore.Authorization
@using Planificador.Application.Interfaces
@using System.Security.Claims
@attribute [Authorize]
@inject AuthenticationStateProvider AuthStateProvider
@inject IPlanningService PlanningService
@inject NavigationManager Navigation

<PageTitle>Dashboard 2026</PageTitle>

<div class="container mt-5">
    <div class="text-center mb-5">
        <h1>👋 Panel de Control</h1>
        <p class="text-muted">Estado del Sistema: <strong class="@StatusColor">@StatusMessage</strong></p>
    </div>

    @if (IsLoading)
    {
        <div class="alert alert-info text-center">
            <div class="spinner-border spinner-border-sm me-2"></div>
            Cargando datos desde Base de Datos...
        </div>
    }
    else if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">
            <h4>🔴 Ocurrió un error</h4>
            <p>@ErrorMessage</p>
        </div>
    }
    else
    {
        <div class="card shadow border-0 text-center p-5">
            <h3 class="text-primary mb-3">
                @(HasPlan ? "✅ Plan Encontrado" : "⚠️ No hay Plan")
            </h3>
            
            <p>ID Usuario: <small>@UserId</small></p>

            <div class="mt-4">
                <a href="/planificacion" class="btn btn-primary btn-lg">
                    @(HasPlan ? "Editar Plan Existente" : "Crear Nuevo Plan") 
                    <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    }
</div>

@code {
    private bool IsLoading = true;
    private bool HasPlan = false;
    private string StatusMessage = "Iniciando...";
    private string StatusColor = "text-warning";
    private string ErrorMessage = "";
    private string UserId = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            StatusMessage = "Autenticando...";
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                UserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "N/A";
                StatusMessage = "Conectando a DB...";
                
                // Probamos la conexión
                HasPlan = await PlanningService.HasPlanForYearAsync(UserId, 2026);
                
                StatusMessage = "Listo";
                StatusColor = "text-success";
            }
            else
            {
                StatusMessage = "Usuario no autenticado";
                StatusColor = "text-danger";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message + " | " + ex.InnerException?.Message;
            StatusMessage = "Error Crítico";
            StatusColor = "text-danger";
        }
        finally
        {
            IsLoading = false;
        }
    }
}